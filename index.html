<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEPT 3000 Words (Exam Mode)</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .letter-blocks {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .letter-block {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.2s;
            text-align: center;
            border: 2px solid transparent; 
            width: 30px; 
        }
        .letter-block:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .letter-block.selected-block {
            background-color: #dc3545; 
            border: 2px solid #bd2130;
        }
        
        .test-area {
            border: 2px solid #ccc;
            padding: 30px;
            border-radius: 8px;
            min-height: 280px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            background-color: #e9ecef;
            text-align: center;
            position: relative;
        }

        /* é€²åº¦æ¢ */
        .progress-info {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.9em;
            color: #666;
            background: rgba(255,255,255,0.7);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .hint-text {
            color: #007bff;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .word-display { font-size: 2.5em; font-weight: bold; color: #333; margin-bottom: 5px; min-height: 1.2em; }
        .kk-display { 
            font-family: 'Lucida Sans Unicode', 'Arial Unicode MS', sans-serif;
            font-size: 1.4em; color: #666; margin-bottom: 15px; min-height: 1.2em;
        }
        .cn-word-display {
            font-size: 1.8em; color: #007bff; margin-bottom: 20px; font-weight: bold;
        }
        .sentence-display {
            font-size: 1.2em; color: #555; margin-bottom: 10px; line-height: 1.4;
        }

        /* è¼¸å…¥æ¡†å€å¡Š */
        .input-group {
            margin-top: 30px; 
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
            max-width: 500px;
        }
        #userInput {
            padding: 10px 15px;
            font-size: 1.2em;
            border: 2px solid #ccc;
            border-radius: 6px;
            width: 70%;
            text-align: center;
            outline: none;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #userInput:focus { border-color: #007bff; }
        #userInput.correct { border-color: #28a745; background-color: #d4edda; }
        #userInput.incorrect { border-color: #dc3545; background-color: #f8d7da; }

        /* é€Ÿåº¦æ§åˆ¶æ¢ */
        .rate-controls {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 25px auto;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 20px;
        }
        .rate-controls label { font-weight: bold; color: #555; margin: 0;}
        #rateSlider { flex-grow: 1; cursor: pointer; }

        /* è¼”åŠ©æŒ‰éˆ• */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; 
            justify-content: center;
            margin-bottom: 20px;
        }
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: background-color 0.3s;
            color: white;
        }
        .voice-btn { background-color: #17a2b8; }
        .voice-btn:hover { background-color: #117a8b; }
        .voice-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .submit-btn {
            background-color: #28a745;
            padding: 10px 25px;
            font-size: 1.1em;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .submit-btn:hover { background-color: #218838; }
        .submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ä¸»è¦è¡Œå‹•æŒ‰éˆ• */
        .action-btn {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            font-size: 1.3em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #333;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .action-btn:active { transform: translateY(2px); }
        .btn-start { background-color: #28a745; color: white; } 
        .btn-giveup { background-color: #ffc107; color: #333; } 
        .btn-giveup:hover { background-color: #e0a800; }
        .btn-next { background-color: #007bff; color: white; }
        .btn-next:hover { background-color: #0056b3; }
        .btn-disabled { background-color: #e9ecef; color: #999; cursor: not-allowed; box-shadow: none; }

        .feedback {
            font-size: 1.2em;
            margin-top: 10px;
            min-height: 30px;
            text-align: center;
            font-weight: bold;
        }

        /* éŒ¯èª¤åˆ—è¡¨è¡¨æ ¼ */
        .summary-container {
            text-align: left;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid #ddd;
            margin-top: 15px;
            padding-top: 10px;
        }
        .error-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .error-table th, .error-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .error-table th { background-color: #f2f2f2; color: #333; }
        .error-row { background-color: #fff5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>GEPT 3000 (Exam Mode)</h1>
        
        <div class="letter-blocks">
            <div class="letter-block">A</div><div class="letter-block">B</div><div class="letter-block">C</div>
            <div class="letter-block">D</div><div class="letter-block">E</div><div class="letter-block">F</div>
            <div class="letter-block">G</div><div class="letter-block">H</div><div class="letter-block">I</div>
            <div class="letter-block">J</div><div class="letter-block">K</div><div class="letter-block">L</div>
            <div class="letter-block">M</div><div class="letter-block">N</div><div class="letter-block">O</div>
            <div class="letter-block">P</div><div class="letter-block">Q</div><div class="letter-block">R</div>
            <div class="letter-block">S</div><div class="letter-block">T</div><div class="letter-block">U</div>
            <div class="letter-block">V</div><div class="letter-block">W</div><div class="letter-block">X</div>
            <div class="letter-block">Y</div><div class="letter-block">Z</div>
        </div>

        <div class="test-area" id="testArea">
            <p class="hint-text">æ­£åœ¨é€£æ¥ GitHub ä¸‹è¼‰å–®å­—åº«...</p>
        </div>
        
        <div class="feedback" id="feedback"></div>

        <div class="input-group">
            <input type="text" id="userInput" placeholder="è«‹è¼¸å…¥å–®å­—..." disabled autocomplete="off">
            <button class="submit-btn" id="submitBtn" disabled>ç­”é¡Œ</button>
        </div>

        <div class="controls">
            <button class="voice-btn" id="btnSpeakWord" disabled>ğŸ”Š å–®å­—ç™¼éŸ³</button>
            <button class="voice-btn" id="btnSpeakSentence" disabled>ğŸ”Š ä¾‹å¥ç™¼éŸ³</button>
        </div>

        <div class="rate-controls">
            <label for="rateSlider">èªé€Ÿ: <span id="rateValue">1.0</span>x</label>
            <input type="range" id="rateSlider" min="0.5" max="1.5" step="0.1" value="1.0">
        </div>
        
        <button class="action-btn btn-disabled" id="actionBtn" disabled>è«‹å…ˆé¸æ“‡å­—æ¯</button>
    </div>

    <script>
        const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/karltpe/MikeEnglishTest/main/word_ad.json';

        // ç‹€æ…‹è®Šæ•¸
        let masterWordList = [];     
        let currentTestQueue = [];   
        let currentWord = null;      
        let selectedLetters = new Set();
        
        let currentIndex = 0;        
        let isAnswerRevealed = false; 
        let correctCount = 0;        
        let incorrectList = [];      
        let isTestRunning = false; // æ˜¯å¦æ­£åœ¨è€ƒè©¦ä¸­

        // DOM å…ƒç´ 
        const testArea = document.getElementById('testArea');
        const feedbackDiv = document.getElementById('feedback');
        const userInput = document.getElementById('userInput');
        const submitBtn = document.getElementById('submitBtn');
        const actionBtn = document.getElementById('actionBtn'); 
        const btnSpeakWord = document.getElementById('btnSpeakWord');
        const btnSpeakSentence = document.getElementById('btnSpeakSentence');
        const letterBlocks = document.querySelectorAll('.letter-block');
        const rateSlider = document.getElementById('rateSlider');
        const rateValueDisplay = document.getElementById('rateValue');

        // åˆå§‹åŒ–
        window.onload = async () => {
            try {
                const response = await fetch(GITHUB_JSON_URL + '?t=' + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                masterWordList = await response.json();
                
                if (!Array.isArray(masterWordList) || masterWordList.length === 0) {
                    throw new Error("JSON æ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ç‚ºç©º");
                }

                testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">
                    è³‡æ–™è¼‰å…¥æˆåŠŸï¼å…± ${masterWordList.length} å€‹å–®å­—ã€‚<br>
                    è«‹é»æ“Šä¸Šæ–¹çš„å­—æ¯æ–¹å¡Šé¸æ“‡ç¯„åœ (ä¾‹å¦‚ A)ã€‚
                </p>`;
                
                actionBtn.textContent = "è«‹å…ˆé¸æ“‡å­—æ¯";

            } catch (error) {
                console.error("è¼‰å…¥å¤±æ•—:", error);
                let msg = error.message;
                if (msg.includes("JSON")) msg += "<br>(è«‹æª¢æŸ¥ GitHub ä¸Šçš„ JSON æª”æ¡ˆæ˜¯å¦æœ‰èªæ³•éŒ¯èª¤)";
                testArea.innerHTML = `<p class="hint-text" style="color: red;">è¼‰å…¥å¤±æ•—: ${msg}</p>`;
            }
            rateValueDisplay.textContent = parseFloat(rateSlider.value).toFixed(1);
        };

        // ----------------------------------------------------
        // æ ¸å¿ƒé‚è¼¯
        // ----------------------------------------------------

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function speak(text) {
            const rate = parseFloat(rateSlider.value);
            if ('speechSynthesis' in window && text) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                window.speechSynthesis.speak(utterance);
            }
        }

        // é–‹å§‹æ–°æ¸¬é©—
        function startNewTest() {
            // 1. ç¯©é¸
            let filtered = masterWordList.filter(item => {
                if (!item.word) return false;
                const firstChar = item.word.charAt(0).toUpperCase();
                return selectedLetters.has(firstChar);
            });

            if (filtered.length === 0) {
                currentTestQueue = [];
                testArea.innerHTML = `<p class="hint-text" style="color:red;">æ‰€é¸å­—æ¯æ²’æœ‰å°æ‡‰çš„å–®å­—ã€‚</p>`;
                updateUIState('idle');
                return;
            }

            // 2. æ´—ç‰Œ & åˆå§‹åŒ–
            currentTestQueue = shuffleArray([...filtered]); 
            currentIndex = 0;
            correctCount = 0;
            incorrectList = [];
            isTestRunning = true; 
            
            // 3. é–‹å§‹ç¬¬ä¸€é¡Œ
            loadQuestion();
        }

        // è¼‰å…¥ç•¶å‰é¡Œç›®
        function loadQuestion() {
            if (currentIndex >= currentTestQueue.length) {
                showSummaryScreen();
                return;
            }

            currentWord = currentTestQueue[currentIndex];
            isAnswerRevealed = false;

            updateUIState('testing');
            userInput.value = "";
            userInput.className = "";
            userInput.focus();
            feedbackDiv.textContent = "";

            const type = currentWord.type ? `(${currentWord.type})` : "";
            const cnWord = currentWord.cn_word || "";
            const cnSentence = currentWord.cn_sentence || "";
            
            let maskedSentence = "";
            if (currentWord.sentence) {
                const escapedWord = currentWord.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b${escapedWord}\\b`, 'gi');
                maskedSentence = currentWord.sentence.replace(regex, '______');
            }

            testArea.innerHTML = `
                <div class="progress-info">é€²åº¦: ${currentIndex + 1} / ${currentTestQueue.length}</div>
                <div id="wordDisplay" class="word-display" style="visibility: hidden;">${currentWord.word}</div>
                <div id="kkDisplay" class="kk-display" style="visibility: hidden;">${currentWord.KK || ""}</div>
                
                <div class="cn-word-display">
                    <span style="font-size: 0.6em; color: #888;">${type}</span> ${cnWord}
                </div>
                <div id="sentenceDisplay" class="sentence-display">${maskedSentence}</div>
                <div class="sentence-display" style="color: #888;">${cnSentence}</div>
            `;
        }

        function showSummaryScreen() {
            updateUIState('finished');
            // ä¿æŒ isTestRunning = falseï¼Œé€™æ¨£æŒ‰éˆ•åŠŸèƒ½æœƒè®Šå› Start é‚è¼¯
            isTestRunning = false; 
            
            const total = currentTestQueue.length;
            const score = total > 0 ? Math.round((correctCount / total) * 100) : 0;
            
            let errorHtml = '';
            if (incorrectList.length > 0) {
                errorHtml = `
                    <div class="summary-container">
                        <h3 style="color: #dc3545;">éŒ¯èª¤å–®å­—åˆ—è¡¨ (${incorrectList.length})</h3>
                        <table class="error-table">
                            <thead><tr><th>å–®å­—</th><th>ä¸­æ–‡</th><th>KK</th></tr></thead>
                            <tbody>
                                ${incorrectList.map(item => `
                                    <tr class="error-row">
                                        <td><strong>${item.word}</strong></td>
                                        <td>${item.cn_word}</td>
                                        <td>${item.KK}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                errorHtml = `<h3 style="color: #28a745; margin-top:20px;">å¤ªæ£’äº†ï¼å…¨å°ï¼ğŸ‰</h3>`;
            }

            testArea.innerHTML = `
                <h2 style="color: #333;">æ¸¬é©—çµæŸ</h2>
                <div style="font-size: 3em; color: ${score >= 60 ? '#28a745' : '#dc3545'}; font-weight: bold; margin: 10px 0;">
                    ${score} <span style="font-size: 0.4em; color: #666;">åˆ†</span>
                </div>
                <p style="font-size: 1.2em;">
                    ç¸½é¡Œæ•¸: ${total} | ç­”å°: ${correctCount} | éŒ¯èª¤: ${incorrectList.length}
                </p>
                ${errorHtml}
            `;
            
            feedbackDiv.textContent = "è«‹æŒ‰ä¸‹æ–¹æŒ‰éˆ•é‡æ–°é–‹å§‹ã€‚";
        }

        function checkAnswer() {
            if (!currentWord || isAnswerRevealed) return;

            const userAns = userInput.value.trim().toLowerCase();
            const correctAns = currentWord.word.trim().toLowerCase();

            if (userAns === correctAns) {
                correctCount++;
                revealAnswer(true);
                feedbackDiv.textContent = "ğŸ‰ ç­”å°äº†ï¼";
                feedbackDiv.style.color = "green";
                userInput.classList.add('correct');
                speak(currentWord.word);
            } else {
                feedbackDiv.textContent = "âŒ æ‹¼å­—éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼Œæˆ–æŒ‰æ”¾æ£„ã€‚";
                feedbackDiv.style.color = "red";
                userInput.classList.add('incorrect');
                setTimeout(() => userInput.classList.remove('incorrect'), 500);
            }
        }

        function giveUp() {
            if (isAnswerRevealed) return;
            incorrectList.push(currentWord);
            revealAnswer(false);
            feedbackDiv.textContent = `ğŸ˜­ ç­”æ¡ˆæ˜¯: ${currentWord.word}`;
            feedbackDiv.style.color = "#d63384";
        }

        function revealAnswer(isCorrect) {
            isAnswerRevealed = true;
            document.getElementById('wordDisplay').style.visibility = 'visible';
            document.getElementById('kkDisplay').style.visibility = 'visible';
            if (currentWord.sentence) {
                document.getElementById('sentenceDisplay').textContent = currentWord.sentence;
            }
            updateUIState('revealed');
        }

        // ==========================================
        // ç‹€æ…‹ç®¡ç† - æ ¸å¿ƒä¿®æ­£éƒ¨åˆ†
        // ==========================================

        // å–®ä¸€æŒ‰éˆ•äº‹ä»¶è™•ç†å™¨ (è§£æ±ºè¡çªçš„é—œéµ)
        actionBtn.addEventListener('click', () => {
            if (actionBtn.disabled) return;

            // 1. å¦‚æœä¸åœ¨è€ƒè©¦ä¸­ (å·²ä¸­æ–· æˆ– å‰›é–‹å§‹ æˆ– å·²çµæŸ) -> åŸ·è¡Œé–‹å§‹
            if (!isTestRunning) {
                startNewTest();
                return;
            }

            // 2. è€ƒè©¦ä¸­ï¼šé‚„æ²’ç­”å° -> æ”¾æ£„
            if (!isAnswerRevealed) {
                giveUp();
                return;
            }

            // 3. è€ƒè©¦ä¸­ï¼šå·²ç¶“ç­”å°/å…¬ä½ˆ -> ä¸‹ä¸€é¡Œ
            if (isAnswerRevealed) {
                currentIndex++;
                loadQuestion();
                return;
            }
        });

        // åƒ…è² è²¬æ›´æ–° UI å¤–è§€ï¼Œä¸è² è²¬ç¶å®šäº‹ä»¶
        function updateUIState(state) {
            switch(state) {
                case 'idle': // é–’ç½® (æœªé–‹å§‹æˆ–å‰›é¸å®Œå­—æ¯)
                    userInput.disabled = true;
                    submitBtn.disabled = true;
                    btnSpeakWord.disabled = true;
                    btnSpeakSentence.disabled = true;
                    
                    if (selectedLetters.size === 0) {
                        actionBtn.textContent = "è«‹å…ˆé¸æ“‡å­—æ¯";
                        actionBtn.className = "action-btn btn-disabled";
                        actionBtn.disabled = true;
                    } else {
                        const sortedLetters = Array.from(selectedLetters).sort().join(", ");
                        actionBtn.textContent = `é–‹å§‹æ¸¬é©— (${sortedLetters})`;
                        actionBtn.className = "action-btn btn-start";
                        actionBtn.disabled = false;
                        
                        testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">
                            å·²é¸æ“‡: <strong>${sortedLetters}</strong><br>
                            æº–å‚™å¥½å¾Œè«‹æŒ‰ä¸‹æ–¹ã€Œé–‹å§‹æ¸¬é©—ã€æŒ‰éˆ•ã€‚
                        </p>`;
                    }
                    break;
                    
                case 'testing': // ç­”é¡Œä¸­
                    userInput.disabled = false;
                    submitBtn.disabled = false;
                    btnSpeakWord.disabled = false;
                    btnSpeakSentence.disabled = false;
                    actionBtn.textContent = "æ”¾æ£„ï¼Œå·çœ‹ç­”æ¡ˆ";
                    actionBtn.className = "action-btn btn-giveup";
                    actionBtn.disabled = false;
                    break;
                    
                case 'revealed': // ç­”æ¡ˆå·²æ­æ›‰
                    userInput.disabled = true;
                    submitBtn.disabled = true;
                    actionBtn.textContent = "ä¸‹ä¸€é¡Œ";
                    actionBtn.className = "action-btn btn-next";
                    actionBtn.disabled = false;
                    break;
                    
                case 'finished': // æ¸¬é©—çµæŸ
                    userInput.disabled = true;
                    submitBtn.disabled = true;
                    btnSpeakWord.disabled = true;
                    btnSpeakSentence.disabled = true;
                    actionBtn.textContent = "é‡æ–°é–‹å§‹ (ä¸‹ä¸€è¼ª)";
                    actionBtn.className = "action-btn btn-next";
                    actionBtn.disabled = false;
                    break;
            }
        }

        // ----------------------------------------------------
        // å…¶ä»–äº‹ä»¶ç›£è½
        // ----------------------------------------------------
        
        letterBlocks.forEach(block => {
            block.addEventListener('click', () => {
                // å¦‚æœæ­£åœ¨è€ƒè©¦ä¸­ï¼Œæ””æˆªé»æ“Š
                if (isTestRunning) {
                    if (!confirm("æ¸¬é©—æ­£åœ¨é€²è¡Œä¸­ï¼Œä¿®æ”¹å­—æ¯å°‡æœƒä¸­æ–·æ¸¬é©—ä¸¦é‡ç½®ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                        return; // ä½¿ç”¨è€…å–æ¶ˆï¼Œä¸å‹•ä½œ
                    }
                    // ä½¿ç”¨è€…ç¢ºèªä¸­æ–·ï¼šé‡ç½®ç‹€æ…‹
                    isTestRunning = false;
                    isAnswerRevealed = false;
                    currentTestQueue = []; // æ¸…ç©ºé¡Œåº«
                }

                const letter = block.textContent.trim();
                block.classList.toggle('selected-block');
                
                if (block.classList.contains('selected-block')) {
                    selectedLetters.add(letter);
                } else {
                    selectedLetters.delete(letter);
                }
                
                updateUIState('idle'); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            });
        });

        submitBtn.addEventListener('click', checkAnswer);
        userInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter' && !submitBtn.disabled) checkAnswer();
        });

        btnSpeakWord.addEventListener('click', () => { if(currentWord) speak(currentWord.word); });
        btnSpeakSentence.addEventListener('click', () => { if(currentWord) speak(currentWord.sentence); });

        rateSlider.addEventListener('input', () => {
            rateValueDisplay.textContent = parseFloat(rateSlider.value).toFixed(1);
        });

    </script>
</body>
</html>
