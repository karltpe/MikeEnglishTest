<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEPT 3000 words (Enhanced)</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        .letter-blocks {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .letter-block {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent; 
            width: 30px; /* 固定寬度讓排列整齊 */
        }
        .letter-block:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .letter-block.selected-block {
            background-color: #dc3545; 
            border: 2px solid #bd2130;
        }
        
        .test-area {
            border: 2px solid #ccc;
            padding: 30px;
            border-radius: 8px;
            min-height: 200px; /* 稍微加高以容納音標 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            background-color: #e9ecef;
            text-align: center;
        }
        .hint-text {
            color: #dc3545;
            font-size: 1.2em;
            font-weight: bold;
        }
        .word-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        /* 新增 KK 音標樣式 */
        .kk-display {
            font-family: 'Lucida Sans Unicode', 'Arial Unicode MS', sans-serif;
            font-size: 1.4em;
            color: #666;
            margin-bottom: 15px;
            font-weight: normal;
        }
        .cn-word-display {
            font-size: 1.5em;
            color: #007bff;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .sentence-display {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .controls button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .show-btn {
            background-color: #17a2b8;
            color: white;
        }
        .show-btn:hover {
            background-color: #117a8b;
        }
        .correct-btn {
            background-color: #28a745;
            color: white;
        }
        .correct-btn:hover {
            background-color: #1e7e34;
        }
        .incorrect-btn {
            background-color: #dc3545;
            color: white;
        }
        .incorrect-btn:hover {
            background-color: #bd2130;
        }
        .start-btn {
            width: 100%;
            background-color: #ffc107;
            color: #333;
            padding: 15px;
            margin-top: 10px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .start-btn:hover {
            background-color: #e0a800;
        }
        .start-btn:disabled {
            background-color: #ffeeba;
            cursor: not-allowed;
        }
        .feedback {
            font-size: 1.1em;
            margin-top: 10px;
            min-height: 25px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GEPT 3000 Words (Enhanced)</h1>
        
        <div class="letter-blocks">
            <div class="letter-block">A</div><div class="letter-block">B</div><div class="letter-block">C</div>
            <div class="letter-block">D</div><div class="letter-block">E</div><div class="letter-block">F</div>
            <div class="letter-block">G</div><div class="letter-block">H</div><div class="letter-block">I</div>
            <div class="letter-block">J</div><div class="letter-block">K</div><div class="letter-block">L</div>
            <div class="letter-block">M</div><div class="letter-block">N</div><div class="letter-block">O</div>
            <div class="letter-block">P</div><div class="letter-block">Q</div><div class="letter-block">R</div>
            <div class="letter-block">S</div><div class="letter-block">T</div><div class="letter-block">U</div>
            <div class="letter-block">V</div><div class="letter-block">W</div><div class="letter-block">X</div>
            <div class="letter-block">Y</div><div class="letter-block">Z</div>
        </div>

        <div class="test-area" id="testArea">
            <p class="hint-text">正在從 GitHub 下載單字庫 (word_ad.json)...</p>
        </div>
        
        <div class="controls">
            <button class="show-btn" id="showChineseWord">單字中文翻譯</button>
            <button class="show-btn" id="showEnglishPronunciation">單字英文發音</button>
            <button class="show-btn" id="showChineseSentence">例句中文翻譯</button>
            <button class="show-btn" id="showEnglishSentence">例句英文發音</button>
            <button class="correct-btn" id="correctBtn" disabled>✓ 答對</button>
            <button class="incorrect-btn" id="incorrectBtn" disabled>✕ 答錯</button>
        </div>
        
        <button class="start-btn" id="startTest" disabled>開始測試 / 下一題</button>
        
        <div class="feedback" id="feedback"></div>
    </div>

    <script>
        // 設定主要資料來源
        const RAW_GITHUB_BASE = 'https://raw.githubusercontent.com/karltpe/MikeEnglishTest/main/';
        const DATA_FILE = 'word_ad.json'; // 新的資料檔名

        const testArea = document.getElementById('testArea');
        const startTestBtn = document.getElementById('startTest');
        const feedbackDiv = document.getElementById('feedback');
        
        const showChineseWordBtn = document.getElementById('showChineseWord');
        const showEnglishPronunciationBtn = document.getElementById('showEnglishPronunciation');
        const showChineseSentenceBtn = document.getElementById('showChineseSentence');
        const showEnglishSentenceBtn = document.getElementById('showEnglishSentence');
        const correctBtn = document.getElementById('correctBtn');
        const incorrectBtn = document.getElementById('incorrectBtn');

        const letterBlocks = document.querySelectorAll('.letter-block');

        // 資料變數
        let masterWordList = []; // 存放下載下來的所有單字
        let currentTestPool = []; // 當前選中字母的單字池
        let currentWord = null;   // 當前正在考的單字物件
        let selectedLetters = new Set(); 
        let isSystemReady = false; 

        // 錯誤單字計數器 (Local Storage)
        let errorCounts = {}; 

        // 語音函式
        function speak(text, lang) {
            if ('speechSynthesis' in window && text) {
                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang; // 'en-US' or 'zh-TW'
                
                if (lang.startsWith('en')) {
                    utterance.rate = 0.85; // 英文稍微放慢一點點
                } else {
                    utterance.rate = 1.0;
                }

                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('您的瀏覽器不支援文字轉語音功能 (TTS) 或缺少文字內容.');
            }
        }
        
        // LocalStorage 載入/儲存
        function loadErrorCounts() {
            const storedData = localStorage.getItem('mike_word_errors_v2'); // 改個key避免跟舊版衝突
            if (storedData) {
                errorCounts = JSON.parse(storedData);
            }
        }

        function saveErrorCounts() {
            localStorage.setItem('mike_word_errors_v2', JSON.stringify(errorCounts));
        }

        // 步驟 1: 載入 master file (word_ad.json)
        async function loadMasterData() {
            loadErrorCounts(); 
            const url = RAW_GITHUB_BASE + DATA_FILE;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`無法載入資料。狀態碼: ${response.status}`);
                }
                masterWordList = await response.json();
                
                // 資料簡單驗證
                if (!Array.isArray(masterWordList) || masterWordList.length === 0) {
                    throw new Error("載入的 JSON 格式錯誤或為空");
                }

                isSystemReady = true; 
                testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">
                    資料載入成功！共 ${masterWordList.length} 個單字。<br>
                    請點擊上方的字母方塊選擇範圍 (可複選)。
                </p>`;
                
            } catch (error) {
                console.error('Error loading data:', error);
                testArea.innerHTML = `<p class="hint-text" style="color: red;">
                    資料載入失敗 (${error.message})。<br>
                    請確認 GitHub 路徑與檔案名稱是否正確 (word_ad.json)。
                </p>`;
                startTestBtn.disabled = true;
                resetControlButtons(true);
            }
        }
        
        // 步驟 2: 根據選取的字母建立題庫
        function updateWordPool() {
            if (!isSystemReady) return;
            
            // 重置介面
            resetControlButtons(true); 
            currentWord = null; 
            startTestBtn.textContent = '開始測試 / 下一題'; 
            feedbackDiv.textContent = '';

            if (selectedLetters.size === 0) {
                testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">請點擊上方的字母方塊選擇單字範圍。</p>`;
                startTestBtn.disabled = true;
                currentTestPool = [];
                return;
            }

            // 篩選邏輯：從 masterWordList 挑出開頭字母符合 selectedLetters 的單字
            currentTestPool = masterWordList.filter(item => {
                if (!item.word) return false;
                const firstChar = item.word.charAt(0).toUpperCase();
                return selectedLetters.has(firstChar);
            });

            // 更新顯示
            if (currentTestPool.length > 0) {
                testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">
                    已選取 ${selectedLetters.size} 個字母，共 ${currentTestPool.length} 個單字。<br>
                    點擊「開始測試」開始！
                </p>`;
                startTestBtn.disabled = false;
            } else {
                testArea.innerHTML = `<p class="hint-text" style="color: red;">選取的字母中沒有對應的單字資料。</p>`;
                startTestBtn.disabled = true;
            }
        }

        // 步驟 3: 處理字母方塊點擊
        letterBlocks.forEach(block => {
            block.addEventListener('click', () => {
                if (!isSystemReady) return; 

                // 檢查是否正在考試中
                if (currentWord !== null && !startTestBtn.disabled) {
                    const confirmation = confirm("更改字母範圍會重置目前的題目。是否確定要更改？");
                    if (!confirmation) return;
                }

                const letter = block.textContent.trim(); // 取得 "A", "B"...
                
                // 切換選取狀態
                block.classList.toggle('selected-block');

                // 更新選取清單
                if (block.classList.contains('selected-block')) {
                    selectedLetters.add(letter);
                } else {
                    selectedLetters.delete(letter);
                }
                
                updateWordPool();
            });
        });

        // 步驟 4: 開始/下一題
        startTestBtn.addEventListener('click', () => {
            if (currentTestPool.length === 0) return;

            // 隨機選字
            const randomIndex = Math.floor(Math.random() * currentTestPool.length);
            currentWord = currentTestPool[randomIndex];
            
            displayQuestion(currentWord);
            
            resetControlButtons(false);
            startTestBtn.textContent = '下一題';
            feedbackDiv.textContent = '';
        });

        // 步驟 5: 顯示題目 (針對新結構調整)
        function displayQuestion(item) {
            const displayWord = item.word; // 英文單字
            const kk = item.KK ? item.KK : ""; // KK音標 (有些可能沒有)
            const type = item.type ? `(${item.type})` : ""; // 詞性
            const cnWord = item.cn_word; // 中文解釋 (新欄位)
            
            // 處理例句挖空
            let maskedSentence = "";
            if (item.sentence) {
                // 簡單的正則表達式來替換單字 (不分大小寫)
                const regex = new RegExp(`\\b${item.word}\\b`, 'gi');
                maskedSentence = item.sentence.replace(regex, '______');
            } else {
                maskedSentence = "(無例句)";
            }

            const cnSentence = item.cn_sentence || "(無例句翻譯)";

            testArea.innerHTML = `
                <div id="wordDisplay" class="word-display" style="color: transparent;">${displayWord}</div>
                <div id="kkDisplay" class="kk-display" style="color: transparent;">${kk}</div>
                
                <div id="translationDisplay" class="cn-word-display" style="color: transparent;">
                    <span style="font-size: 0.6em; color: #888;">${type}</span> ${cnWord}
                </div>
                
                <div id="sentenceDisplay" class="sentence-display">${maskedSentence}</div>
                <div id="sentenceTranslationDisplay" class="sentence-display" style="color: transparent;">${cnSentence}</div>
            `;
        }
        
        // 步驟 6: 按鈕顯示控制
        function handleShowButton(type) {
            if (!currentWord) return;
            
            if (type === 'word_zh') {
                document.getElementById('translationDisplay').style.color = 'black'; // 顯示中文與詞性
                speak(currentWord.cn_word, 'zh-TW');
            } else if (type === 'word_en') {
                document.getElementById('wordDisplay').style.color = '#333';
                document.getElementById('kkDisplay').style.color = '#666'; // 顯示 KK
                speak(currentWord.word, 'en-US');
            } else if (type === 'sentence_zh') {
                document.getElementById('sentenceTranslationDisplay').style.color = '#555';
                speak(currentWord.cn_sentence, 'zh-TW');
            } else if (type === 'sentence_en') {
                // 顯示完整例句 (把挖空填回去)
                const originalSentence = currentWord.sentence;
                document.getElementById('sentenceDisplay').textContent = originalSentence;
                speak(originalSentence, 'en-US');
            }
        }
        
        showChineseWordBtn.addEventListener('click', () => handleShowButton('word_zh'));
        showEnglishPronunciationBtn.addEventListener('click', () => handleShowButton('word_en'));
        showChineseSentenceBtn.addEventListener('click', () => handleShowButton('sentence_zh'));
        showEnglishSentenceBtn.addEventListener('click', () => handleShowButton('sentence_en'));

        // 答對/答錯按鈕
        correctBtn.addEventListener('click', () => showAnswer('✓ 恭喜答對！'));
        
        incorrectBtn.addEventListener('click', () => {
            if (currentWord && currentWord.word) {
                const w = currentWord.word.toLowerCase();
                errorCounts[w] = (errorCounts[w] || 0) + 1; 
                saveErrorCounts(); 
                console.log(`單字 "${w}" 錯誤次數: ${errorCounts[w]}`);
            }
            showAnswer('✕ 答錯了，請再加強！');
        });
        
        function showAnswer(message) {
            if (!currentWord) return;
            
            // 顯示所有隱藏資訊
            document.getElementById('wordDisplay').style.color = '#333';
            document.getElementById('kkDisplay').style.color = '#666';
            document.getElementById('translationDisplay').style.color = 'black';
            document.getElementById('sentenceTranslationDisplay').style.color = '#555';
            document.getElementById('sentenceDisplay').textContent = currentWord.sentence;
            
            feedbackDiv.textContent = message;
            feedbackDiv.style.color = message.includes('✓') ? 'green' : 'red';
            
            resetControlButtons(true);
            startTestBtn.disabled = false; 
        }

        function resetControlButtons(disableAll) {
            showChineseWordBtn.disabled = disableAll;
            showEnglishPronunciationBtn.disabled = disableAll;
            showChineseSentenceBtn.disabled = disableAll;
            showEnglishSentenceBtn.disabled = disableAll;
            correctBtn.disabled = disableAll;
            incorrectBtn.disabled = disableAll;
        }

        // 初始化
        window.onload = loadMasterData;
    </script>
</body>
</html>
