<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—ä¾‹å¥æŠ½è€ƒæ¸¬è©¦ (å­—æ¯æ–¹å¡Šè¤‡é¸)</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        .letter-blocks {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .letter-block {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* é è¨­é‚Šæ¡† */
            border: 2px solid transparent; 
        }
        .letter-block:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        /* ğŸ¨ é—œéµä¿®æ”¹: é¸å–å¾Œçš„è¦–è¦ºæ•ˆæœ (åç´…) */
        .letter-block.selected-block {
            background-color: #dc3545; /* å¼·çƒˆçš„ç´…è‰² */
            border: 2px solid #bd2130;
        }
        
        .test-area {
            border: 2px solid #ccc;
            padding: 30px;
            border-radius: 8px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            background-color: #e9ecef;
            text-align: center;
        }
        .hint-text {
            color: #dc3545;
            font-size: 1.2em;
            font-weight: bold;
        }
        .word-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .sentence-display {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .controls button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .show-btn {
            background-color: #17a2b8;
            color: white;
        }
        .show-btn:hover {
            background-color: #117a8b;
        }
        .correct-btn {
            background-color: #28a745;
            color: white;
        }
        .correct-btn:hover {
            background-color: #1e7e34;
        }
        .incorrect-btn {
            background-color: #dc3545;
            color: white;
        }
        .incorrect-btn:hover {
            background-color: #bd2130;
        }
        .start-btn {
            width: 100%;
            background-color: #ffc107;
            color: #333;
            padding: 15px;
            margin-top: 10px;
        }
        .start-btn:hover {
            background-color: #e0a800;
        }
        .feedback {
            font-size: 1.1em;
            margin-top: 10px;
            min-height: 25px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å–®å­—ä¾‹å¥æŠ½è€ƒæ¸¬è©¦ (å­—æ¯æ–¹å¡Šè¤‡é¸)</h1>
        
        <div class="letter-blocks">
            <div class="letter-block" data-file="a.json">A</div>
            <div class="letter-block" data-file="b.json">B</div>
            <div class="letter-block" data-file="c.json">C</div>
            <div class="letter-block" data-file="d.json">D</div>
            <div class="letter-block" data-file="e.json">E</div>
            <div class="letter-block" data-file="f.json">F</div>
            <div class="letter-block" data-file="g.json">G</div>
            <div class="letter-block" data-file="h.json">H</div>
            <div class="letter-block" data-file="i.json">I</div>
            <div class="letter-block" data-file="j.json">J</div>
            <div class="letter-block" data-file="k.json">K</div>
            <div class="letter-block" data-file="l.json">L</div>
            <div class="letter-block" data-file="m.json">M</div>
            <div class="letter-block" data-file="n.json">N</div>
            <div class="letter-block" data-file="o.json">O</div>
            <div class="letter-block" data-file="p.json">P</div>
            <div class="letter-block" data-file="q.json">Q</div>
            <div class="letter-block" data-file="r.json">R</div>
            <div class="letter-block" data-file="s.json">S</div>
            <div class="letter-block" data-file="t.json">T</div>
            <div class="letter-block" data-file="u.json">U</div>
            <div class="letter-block" data-file="v.json">V</div>
            <div class="letter-block" data-file="w.json">W</div>
            <div class="letter-block" data-file="x.json">X</div>
            <div class="letter-block" data-file="y.json">Y</div>
            <div class="letter-block" data-file="z.json">Z</div>
        </div>

        <div class="test-area" id="testArea">
            <p class="hint-text">æ­£åœ¨å˜—è©¦å¾ GitHub è¼‰å…¥å­—å…¸...</p>
        </div>
        
        <div class="controls">
            <button class="show-btn" id="showChineseWord">å–®å­—ä¸­æ–‡ç¿»è­¯</button>
            <button class="show-btn" id="showEnglishPronunciation">å–®å­—è‹±æ–‡ç™¼éŸ³</button>
            <button class="show-btn" id="showChineseSentence">ä¾‹å¥ä¸­æ–‡ç¿»è­¯</button>
            <button class="show-btn" id="showEnglishSentence">ä¾‹å¥è‹±æ–‡ç™¼éŸ³</button>
            <button class="correct-btn" id="correctBtn" disabled>âœ“ ç­”å°</button>
            <button class="incorrect-btn" id="incorrectBtn" disabled>âœ• ç­”éŒ¯</button>
        </div>
        
        <button class="start-btn" id="startTest" disabled>é–‹å§‹æ¸¬è©¦ / ä¸‹ä¸€é¡Œ</button>
        
        <div class="feedback" id="feedback"></div>
    </div>

    <script>
        // æ‚¨çš„ GitHub é ç«¯è³‡æ–™åº«è·¯å¾‘
        const RAW_GITHUB_BASE = 'https://raw.githubusercontent.com/karltpe/MikeEnglishTest/main/';

        const testArea = document.getElementById('testArea');
        const startTestBtn = document.getElementById('startTest');
        const feedbackDiv = document.getElementById('feedback');
        
        const showChineseWordBtn = document.getElementById('showChineseWord');
        const showEnglishPronunciationBtn = document.getElementById('showEnglishPronunciation');
        const showChineseSentenceBtn = document.getElementById('showChineseSentence');
        const showEnglishSentenceBtn = document.getElementById('showEnglishSentence');
        const correctBtn = document.getElementById('correctBtn');
        const incorrectBtn = document.getElementById('incorrectBtn');

        const letterBlocks = document.querySelectorAll('.letter-block');

        let wordData = []; // åˆä½µå¾Œçš„ç¸½é¡Œåº«
        let wordDictionary = {}; 
        let currentWord = null;
        let selectedFiles = new Set(); // è¿½è¹¤æ‰€æœ‰é¸å–çš„æª”æ¡ˆåç¨± (è¤‡é¸)
        let isSystemReady = false; 

        // TTS æ–‡å­—è½‰èªéŸ³æ ¸å¿ƒå‡½å¼ (ä¸è®Š)
        function speak(text, lang) {
            if ('speechSynthesis' in window && text) {
                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                
                if (lang.startsWith('en')) {
                    utterance.rate = 0.9;
                } else if (lang.startsWith('zh')) {
                    utterance.rate = 1.0;
                }

                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æ–‡å­—è½‰èªéŸ³åŠŸèƒ½ (TTS) æˆ–ç¼ºå°‘æ–‡å­—å…§å®¹.');
            }
        }
        
        // æ­¥é©Ÿ 1: è¼‰å…¥ç¸½å­—å…¸ (ä¸è®Š)
        async function loadWordDictionary() {
            const dictionaryUrl = RAW_GITHUB_BASE + 'word_dictionary.json';
            try {
                const response = await fetch(dictionaryUrl);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•å¾ GitHub è¼‰å…¥ç¸½å­—å…¸ã€‚ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                wordDictionary = await response.json();
                isSystemReady = true; 
                
                testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">å­—å…¸è¼‰å…¥æˆåŠŸï¼è«‹é»æ“Šä¸Šæ–¹çš„å­—æ¯æ–¹å¡Šé¸æ“‡å–®å­—ç¯„åœ (å¯è¤‡é¸)ã€‚</p>`;
                
            } catch (error) {
                console.error('Error loading word dictionary:', error.message);
                testArea.innerHTML = `<p class="hint-text" style="color: red;">ç¸½å­—å…¸è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ– GitHub è·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚</p>`;
                
                startTestBtn.disabled = true;
                letterBlocks.forEach(block => block.style.pointerEvents = 'none');
                resetControlButtons(true);
            }
        }
        
        // æ­¥é©Ÿ 2: è¼‰å…¥ä¸¦åˆä½µæ‰€æœ‰é¸å–çš„ JSON æª”æ¡ˆ (æ–°å¢æ ¸å¿ƒå‡½å¼)
        async function loadSelectedWords() {
            if (!isSystemReady) return; 
            
            // é‡ç½®é¡Œåº«
            wordData = []; 

            if (selectedFiles.size === 0) {
                testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">è«‹é»æ“Šä¸Šæ–¹çš„å­—æ¯æ–¹å¡Šé¸æ“‡å–®å­—ç¯„åœã€‚</p>`;
                startTestBtn.disabled = true;
                return;
            }

            const fetchPromises = Array.from(selectedFiles).map(fileName => 
                fetch(RAW_GITHUB_BASE + fileName)
                    .then(response => {
                        if (!response.ok) {
                            console.warn(`Warning: Could not load ${fileName}. Status: ${response.status}`);
                            return []; // è¼‰å…¥å¤±æ•—å›å‚³ç©ºé™£åˆ—
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error(`Error fetching ${fileName}:`, error);
                        return []; // éŒ¯èª¤æ™‚å›å‚³ç©ºé™£åˆ—
                    })
            );

            // ç­‰å¾…æ‰€æœ‰æª”æ¡ˆè¼‰å…¥å®Œæˆ
            const allDataArrays = await Promise.all(fetchPromises);
            
            // åˆä½µæ‰€æœ‰æˆåŠŸçš„å–®å­—é™£åˆ—
            wordData = allDataArrays.flat(); 

            // æ›´æ–°ä»‹é¢ç‹€æ…‹
            if (wordData.length > 0) {
                testArea.innerHTML = `<p class="hint-text" style="color: #007bff; font-weight: normal;">å·²è¼‰å…¥ ${wordData.length} å€‹å–®å­— (ä¾†è‡ª ${selectedFiles.size} å€‹å­—æ¯)ã€‚é»æ“Šã€Œé–‹å§‹æ¸¬è©¦ã€é–‹å§‹ï¼</p>`;
                startTestBtn.disabled = false;
            } else {
                testArea.innerHTML = `<p class="hint-text" style="color: red;">è¼‰å…¥çš„æª”æ¡ˆä¸­æ²’æœ‰å¯ç”¨çš„å–®å­—è³‡æ–™ã€‚</p>`;
                startTestBtn.disabled = true;
            }

            feedbackDiv.textContent = '';
            resetControlButtons(true);
        }


        // æ­¥é©Ÿ 3: è™•ç†å­—æ¯æ–¹å¡Šé»æ“Š (é—œéµä¿®æ”¹ï¼šæ”¯æ´è¤‡é¸)
        letterBlocks.forEach(block => {
            block.addEventListener('click', () => {
                if (!isSystemReady) return; 

                const fileName = block.getAttribute('data-file');
                
                // 1. è¦–è¦ºç‹€æ…‹åˆ‡æ› (.selected-block class)
                block.classList.toggle('selected-block');

                // 2. è¿½è¹¤æª”æ¡ˆåˆ‡æ›
                if (block.classList.contains('selected-block')) {
                    selectedFiles.add(fileName);
                } else {
                    selectedFiles.delete(fileName);
                }
                
                // 3. é‡æ–°è¼‰å…¥åˆä½µé¡Œåº«
                loadSelectedWords();
            });
        });

        // æ­¥é©Ÿ 4: é–‹å§‹/ä¸‹ä¸€é¡Œé‚è¼¯ (ä¸è®Š)
        startTestBtn.addEventListener('click', () => {
            if (wordData.length === 0) {
                feedbackDiv.textContent = 'è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹å­—æ¯æ–¹å¡Šã€‚';
                return;
            }

            // éš¨æ©Ÿå¾åˆä½µå¾Œçš„ wordData ä¸­é¸å–
            const randomIndex = Math.floor(Math.random() * wordData.length);
            currentWord = wordData[randomIndex];
            
            displayQuestion(currentWord);
            
            resetControlButtons(false);
            startTestBtn.textContent = 'ä¸‹ä¸€é¡Œ';
            feedbackDiv.textContent = '';
        });

        // æ­¥é©Ÿ 5: é¡¯ç¤ºå•é¡Œï¼ˆä¾‹å¥ï¼Œå–®å­—æŒ–ç©ºï¼‰ (ä¸è®Š)
        function displayQuestion(item) {
            const displayWord = item.word.toUpperCase();
            const maskedSentence = item.sentence.replace(new RegExp('\\b' + item.word + '\\b', 'gi'), '_____');

            // åˆå§‹æ™‚æ‰€æœ‰ç­”æ¡ˆæ–‡æœ¬éƒ½æ˜¯é€æ˜çš„ (éš±è—çš„)
            testArea.innerHTML = `
                <div id="wordDisplay" class="word-display" style="color: transparent;">${displayWord}</div>
                <div id="translationDisplay" class="word-display" style="color: transparent;">${wordDictionary[item.word] || 'ç„¡ç¿»è­¯'}</div>
                <div id="sentenceDisplay" class="sentence-display">${maskedSentence}</div>
                <div id="sentenceTranslationDisplay" class="sentence-display" style="color: transparent;">${item.translation}</div>
            `;
        }
        
        // æ­¥é©Ÿ 6: è™•ç†æç¤ºæŒ‰éˆ• (åªç™¼éŸ³ï¼Œä¸é¡¯ç¤ºæ–‡æœ¬)
        function handleShowButton(targetId, type) {
            if (!currentWord) return;
            
            // é»æ“Šä¸­æ–‡ç¿»è­¯æŒ‰éˆ•æ™‚ï¼Œå°‡ä¸­æ–‡ç¿»è­¯æ–‡æœ¬é¡¯ç¤ºå‡ºä¾†
            if (type === 'word_zh') {
                document.getElementById('translationDisplay').style.color = 'black';
                const chineseText = wordDictionary[currentWord.word] || 'ç„¡ç¿»è­¯';
                speak(chineseText, 'zh-TW');
                return; // åŸ·è¡Œå®Œç•¢
            } else if (type === 'sentence_zh') {
                document.getElementById('sentenceTranslationDisplay').style.color = 'black';
                speak(currentWord.translation, 'zh-TW');
                return; // åŸ·è¡Œå®Œç•¢
            }
            
            // åŸ·è¡Œç™¼éŸ³ (è‹±æ–‡å–®å­—å’Œä¾‹å¥)
            if (type === 'word_en') {
                speak(currentWord.word, 'en-US');
            } else if (type === 'sentence_en') {
                speak(currentWord.sentence, 'en-US');
            }
        }
        
        // æŒ‰éˆ•é»æ“Šäº‹ä»¶å°æ‡‰ç™¼éŸ³é¡å‹
        showChineseWordBtn.addEventListener('click', () => handleShowButton('translationDisplay', 'word_zh'));
        showEnglishPronunciationBtn.addEventListener('click', () => handleShowButton('wordDisplay', 'word_en'));
        showChineseSentenceBtn.addEventListener('click', () => handleShowButton('sentenceTranslationDisplay', 'sentence_zh'));
        showEnglishSentenceBtn.addEventListener('click', () => handleShowButton('sentenceDisplay', 'sentence_en'));

        // æ­¥é©Ÿ 7: è™•ç†ç­”é¡ŒæŒ‰éˆ•
        correctBtn.addEventListener('click', () => showAnswer('âœ“ æ­å–œç­”å°ï¼'));
        incorrectBtn.addEventListener('click', () => showAnswer('âœ• ç­”éŒ¯äº†ï¼Œè«‹å†åŠ å¼·ï¼'));
        
        // é¡¯ç¤ºç­”æ¡ˆä¸¦æº–å‚™ä¸‹ä¸€é¡Œ
        function showAnswer(message) {
            if (!currentWord) return;
            
            // é¡¯ç¤ºæ‰€æœ‰ç­”æ¡ˆ
            document.getElementById('wordDisplay').style.color = 'black';
            document.getElementById('translationDisplay').style.color = 'black';
            document.getElementById('sentenceTranslationDisplay').style.color = 'black';
            
            feedbackDiv.textContent = message;
            
            // ç¦ç”¨æç¤ºæŒ‰éˆ•ï¼Œå•Ÿç”¨ä¸‹ä¸€é¡Œ
            resetControlButtons(true);
            startTestBtn.disabled = false; 
        }

        // æ­¥é©Ÿ 8: é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        function resetControlButtons(disableAll) {
            // ä¸­æ–‡ç¿»è­¯æŒ‰éˆ•æ‡‰è©²å§‹çµ‚å•Ÿç”¨ï¼Œä»¥ä¾¿æŸ¥çœ‹ç¿»è­¯
            showChineseWordBtn.disabled = disableAll; 
            showEnglishPronunciationBtn.disabled = disableAll;
            showChineseSentenceBtn.disabled = disableAll;
            showEnglishSentenceBtn.disabled = disableAll;
            correctBtn.disabled = disableAll;
            incorrectBtn.disabled = disableAll;
        }

        // å•Ÿå‹•æ™‚è¼‰å…¥å­—å…¸
        window.onload = loadWordDictionary;
    </script>
</body>
</html>
